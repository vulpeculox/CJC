// Title: CJC  Purpose: JSON for ES6 etc.  Licence: MIT   Author: Peter Fox  Contact: cjc@vulpeculox.net  Built: 30/11/2018, 15:56:06
class CJC{static DeepCopy(t){CJC_DATA.deepCopying=!0;var r=CJC.FromJ(CJC.ToJ(t));return CJC_DATA.deepCopying=!1,r}static toJSON(t){return CJC.ToJ(t)}static ToJ(t){var r=CJC._NewObjList(),e=CJC._AddClassNames(r,t);return CJC._RemoveObjList(r),JSON.stringify(e)}static _AddClassNames(t,r){if(Array.isArray(r))return r.map(r=>CJC._AddClassNames(t,r));var e=[null,void 0].indexOf(r);if(e>-1)return["CJC_NULL","CJC_UNDEFINED"][e];if(Number.isNaN(r))return"CJC_NAN";if("object"==typeof r){if(r instanceof Date)return{_class_name_:"Date",value:r.getTime()};if(r instanceof RegExp)return{_class_name_:"RegExp",value:r.toString()};if(!1===CJC_DATA.deepCopying)for(var n=0;n<CJC_DATA.dontStore.length;){if(r instanceof CJC_DATA.dontStore[n][0])return CJC_DATA.dontStore[n][1]+" object removed by CJC";n++}var o=CJC._InExportedList(t,r);if(!1!==o)return{CJC_PLACEHOLDER:o};var s=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);r.CJC_IDENTITY=s,CJC._AddToExportedList(t,r);var C=Object.assign({},r);Object.entries(C).forEach(function(r){C[r[0]]=CJC._AddClassNames(t,r[1])});var i=r.constructor.name;return"Object"!=i&&(C._class_name_=i),C}return r}static _InExportedList(t,r){var e=CJC_DATA.objLists[t].indexOf(r);return!(e<0)&&CJC_DATA.objLists[t][e].CJC_IDENTITY}static _AddToExportedList(t,r){CJC_DATA.objLists[t].push(r)}static fromJSON(t){return CJC.FromJ(t)}static FromJ(t){var r,e=typeof t;if("string"!=e)return"CJC.FromJ: EXPECTED STRING.  Given "+e;try{r=JSON.parse(t,CJC._Reconstructor)}catch(r){return console.log(t.replace(/,/g,",\n")),CJC._JsonErrToString(r,t)}var n=CJC._NewObjList();return r=CJC._ApplyDeferred(n,r),CJC._RemoveObjList(n),r}static _Reconstructor(t,r){if("string"==typeof r)return"CJC_NULL"==r?null:"CJC_NAN"==r?Number.NaN:r;if("object"==typeof r&&r.hasOwnProperty("_class_name_")){var e=r._class_name_;if(delete r._class_name_,"Date"==e)return new Date(r.value);if("RegExp"==e){var n=r.value.split("/");n.shift();var o=n.pop();return new RegExp(n.join("/"),o)}var s=window[e];if(s||(s=CJC._GetConstructor(e)),s){var C=new s;return Object.entries(r).forEach(function(t){C[t[0]]=t[1]}),C}}return r}static _ApplyDeferred(t,r){return CJC._AddToDeferred(t,r),Object.entries(r).forEach(function(e){var n=e[0],o=e[1];if("object"==typeof o){if(null===o)return;if(Array.isArray(o))return o=o.map(r=>CJC._ApplyDeferred(t,r)),void(r[n]=o);if(o.hasOwnProperty("CJC_PLACEHOLDER")){var s=o.CJC_PLACEHOLDER,C=CJC._FetchDeferred(t,s);r[n]=C}else o.hasOwnProperty("CJC_IDENTITY")&&(CJC._AddToDeferred(t,o),r[n]=CJC._ApplyDeferred(t,o))}}),r}static _FetchDeferred(t,r){var e=CJC_DATA.objLists[t].find(function(t){return t.CJC_IDENTITY==r});return void 0===e&&(e="CJC MISSING DEFERRED OBJECT ERROR"),e}static _AddToDeferred(t,r){CJC_DATA.objLists[t].push(r)}static _NewObjList(){var t="R"+Math.floor(99999999*Math.random());return CJC_DATA.objLists[t]=[],t}static _RemoveObjList(t){CJC_DATA.objLists[t].forEach(function(t){delete t.CJC_IDENTITY}),delete CJC_DATA.objLists[t]}static RegisterConstructors(t){t.forEach(function(t){CJC_DATA.constructors[t.name]=t})}static IsConstructorRegistered(t){return Object.keys(CJC_DATA.constructors).includes(t)}static _GetConstructor(t){return CJC_DATA.constructors[t]}static DumpConstructorNames(){return Object.keys(CJC_DATA.constructors).sort().join("|")}static get about(){return"Version: {{BUILDDATE}}\nReference:vulpeculox.net/misc/jsjq/CJC/index.htm"}static _JsonErrToString(t,r){console.log("JE2S",t.toString());var e=t.toString().split(":"),n=e[0].trim(),o=/(\d+)\D+(\d+)/.exec(n),s=0,C=0;o&&(s=Number.parseInt(o[1],10)-1,C=Number.parseInt(o[2],10)-20);var i=(e=r.split("\n"))[s=s>e.length-1?0:s];return"CJC.FromJ: PARSE FAILED. Info\n"+n+"\nLikely area starting at character "+((C=(C=C<0?0:C)>i.length-1?0:C)+1)+' "'+i.substr(C,50)+'"'}static RemoveComponentUplinks(t,r,e){CJC._ReplaceUpLink(t,r,null,e)}static ReplaceComponentUplinks(t,r,e){CJC._ReplaceUpLink(t,r,t,e)}static _ReplaceUpLink(t,r,e,n){(Object.entries(t).filter(t=>"object"==typeof t[1]).filter(t=>!1===Array.isArray(t[1])).filter(t=>r in t[1]).map(t=>t[0]).forEach(function(n){t[n][r]=e}),n)&&Object.entries(t).filter(t=>Array.isArray(t[1])).map(t=>t[1]).forEach(function(t){t.forEach(function(t){"object"==typeof t&&!1===Array.isArray(t)&&(t[r]=e)})})}static doNotStringify(t,r){CJC_DATA.dontStore.push([t,r])}static Block(t,r){CJC.doNotStringify(t,r)}}var CJC_DATA={constructors:{},objLists:{},dontStore:[],deepCopying:!1};jQuery&&CJC.Block(jQuery,"jQuery");